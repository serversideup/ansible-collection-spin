---
- name: Install Docker (when OS is Debian based)
  ansible.builtin.include_tasks: setup-Debian.yml
  when: ansible_os_family == 'Debian'
  tags: install-docker

- name: Configure Docker User.
  ansible.builtin.include_role:
    name: serversideup.spin.docker_user

- name: Initialize Docker Swarm.
  community.docker.docker_swarm:
    state: present
    advertise_addr: "{{ docker_swarm.advertise_addr }}"
  when: "'swarm_managers' in group_names"

- name: Open HTTP and HTTPS ports (if enabled)
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: "tcp"
    comment: "Allow HTTP connections."
  loop:
    - "80"
    - "443"
  # Set backwards compatibility for the automatically_open_http_and_https_ports variable
  when: (automatically_open_http_and_https_ports | default(docker_open_web_ports)) | bool
  notify: Enable ufw

- name: Set CRON for Docker system prune.
  ansible.builtin.cron:
    name: "Prune unused Docker images, containers, and networks"
    minute: "0"
    hour: "4"
    # To view the logs, run: sudo journalctl -t docker-prune --since "7 days ago"
    job: "/usr/bin/docker system prune --all --force 2>&1 | logger -t docker-prune"
